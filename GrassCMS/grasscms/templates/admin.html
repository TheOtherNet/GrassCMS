{% extends "layout.html" %}
{% block menu %} {%endblock%}

{% block head %}
    <script src="{{url_for('static', filename='js/jquery-ui.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/grasscms.js')}}"></script>
    <script src="{{url_for('static', filename='ckeditor/ckeditor.js')}}"></script>
    <script src="{{url_for('static', filename='ckeditor/adapters/jquery.js')}}"></script>
    <script>
    function setup_text(){
        $('.draggable').draggable({handle: '.handler', stop: function(ev, ui){ $.ajax({ url: '/set_position/text/' + get_txt_pos(this, ui)});}});
        $('.CKeditor_blob').ckeditor(addevents);
    }

    function addevents(editor){
        editor=CKEDITOR.instances[$(editor).attr('id')]; console.debug(editor);

        editor.on("blur", function(event) { 
            $('.container').css('height','auto');
            $("#handler_" + event.editor.name ).toggle(); 
            $("#cke_top_" + event.editor.name ).toggle(); 
            $("#cke_bottom_" + event.editor.name ).toggle(); 
        });

        editor.on("focus", function(event) { 
            $('.container').css('height','5em');
            $("#handler_" + event.editor.name ).toggle(); 
            $("#cke_top_" + event.editor.name ).toggle(); 
            $("#cke_bottom_" + event.editor.name ).toggle(); 
        });

    }
    //    $('.CKeditor_blob').each(function(ck){ var editor = $(ck).ckeditorGet(); console.debug(editor); editor.on('click', function(ev){ console.debug("FOO"); }); });
    </script>
    <script> $(function(){ grasscms_startup(); }); </script>
{%endblock%}

{% block admin_menu %}
        <li class="menu_button">
            <form style="width:42px" id="fileupload" action="/upload/{{page.name}}" method="POST" enctype="multipart/form-data">
                <input style="width:0px;height:0px" type="file" id="files" class="files" name="files" >
                <img title="Upload files" src="{{url_for('static', filename='images/add.png')}}" id="fakefiles" />
                <div style="position:fixed; top:0px; left:-100px; width:0px;">
                    <input type="submit"/>
                </div>
            </form>
        </li>

        <li class="menu_button">
                <a onclick="get_blob('{{page.name}}'); return false" href="#">
                    <img title="Add new text" src="{{url_for('static', filename='images/text.png')}}" />
                </a>
        </li>

        <li class="menu_button">
                <a onclick="get_menu('{{blog.name}}','{{blog.id}}','{{page.name}}'); return false" href="#">
                    <img title="Add new menu" src="{{url_for('static', filename='images/menu.png')}}" />
                </a>
        </li>

        <li class="menu_button">
            <form id="newpage" action="#" onsubmit="create_page(); return false">
                <img title="Add new page" src="{{url_for('static', filename='images/page.png')}}" onclick="$('#new_page_div').toggle(100); $('#new_page_div').css('display','inline')" />
                <div id="new_page_div" style="display:inline; display:none; ">
                    <input type="text" id="new_page" name="page" placeholder="Page name" required />
                    <span><a href="#" onclick="create_page()">Create page</a></span>
                </div>
                <div style="position:fixed; top:0px; left:-100px; width:0px;">
                    <input type="submit"/>
                </div>
            </form>
        </li>

{%endblock%} 

{% block body %}
    <div id="filedrag"> 
        <h1>{{title}}</h1>
        {% if imgs %} 
            {% for img in imgs %}
                <img class="img" style=" width:{{img.width}}px; height: {{img.height}}px;"
                     id="{{ img.id_ }}"  src='/static/uploads/{{ img.content }}' />
            {%endfor%}
        {%endif%}

        {% if txts %} {% for txt, content in txts %} 
            <div class="text_blob draggable texts" style="top:{{txt.x}}px; left:{{txt.y}}px;" id="{{ txt.id_ }}" >
                <div class="handler" id="handler_text_{{txt.id_}}" style="display:none; background:black; border-radius:3px"> <a onclick="$('cke_top').hide(); $('cke_bottom').hide(); $('#cke_bottom_text_{{txt.id_}}').toggle(); $('#cke_top_text_{{txt.id_}}').toggle();" href="#"> <i class="icon icon-edit"></i></a> </div>
                <div>
                    <textarea style="min-width:4em; min-height:5em;"  
                        id='text_{{txt.id_}}' class="{{page.name}}  CKeditor_file editor"> 
                            {{ content }}</textarea>
                </div>
            </div> 
        {%endfor%} {%endif%}

        {% if txt_blobs %} {% for txt in txt_blobs %} 
            <div class="text_blob draggable texts" style="top:{{txt.x}}px; left:{{txt.y}}px;" id="{{ txt.id_ }}" >
                <div class="handler" style="display:none; background:black; height:4px; border-radius:3px" id="handler_text_{{txt.id_}}" > </div>
                <div>
                    <textarea style="min-width:4em; min-height:5em;" 
                        id='text_{{txt.id_}}' class="{{page.name}} CKeditor_blob editor"> 
                            {{ txt.content }}</textarea>
                </div>
            </div> 
        {%endfor%} {%endif%}

    </div>

    <script src="/static/js/jquery.ui.widget.js"></script>
    <script src="/static/js/jquery.iframe-transport.js"></script>
    <script src="/static/js/jquery.fileupload.js"></script>
    <script src="/static/js/jquery.fileupload-ui.js"></script>
    <script src="/static/js/application.js"></script>
    <!--[if gte IE 8]><script src="cors/jquery.xdr-transport.js"></script><![endif]-->
{% endblock %}
